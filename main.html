<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connection Lost</title>
  <style>
    /* ... (all your existing styles unchanged) ... */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Georgia', serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #e8e8e8;
      overflow: hidden;
      cursor: none;
      user-select: none;
      height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at var(--mouse-x, 50%) var(--mouse-y, 50%), 
                                  rgba(255,255,255,0.03) 0%, 
                                  rgba(255,255,255,0.01) 40%, 
                                  transparent 80%);
      pointer-events: none;
      transition: opacity 0.3s ease;
      opacity: 0;
    }

    body.active::before {
      opacity: 1;
    }

    .cursor {
      position: fixed;
      width: 8px;
      height: 8px;
      background: rgba(255,255,255,0.6);
      border-radius: 50%;
      pointer-events: none;
      z-index: 10000;
      transform: translate(-50%, -50%);
      transition: all 0.1s ease;
    }

    .cursor.fade {
      opacity: 0.3;
      transform: translate(-50%, -50%) scale(1.5);
    }

    .hud {
      position: fixed;
      z-index: 1000;
      font-size: 14px;
      font-family: 'Courier New', monospace;
    }

    .memory-counter {
      top: 30px;
      right: 30px;
      color: #ff6b6b;
      background: rgba(0,0,0,0.7);
      padding: 8px 12px;
      border: 1px solid rgba(255,107,107,0.3);
      border-radius: 3px;
      backdrop-filter: blur(10px);
      transition: all 0.4s ease;
    }

    .memory-counter.flash {
      border-color: #ff6b6b;
      box-shadow: 0 0 20px rgba(255,107,107,0.3);
      transform: scale(1.05);
    }

    .start-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 1500;
      max-width: 500px;
      padding: 40px;
    }

    .start-text {
      color: #b8b8b8;
      font-size: 18px;
      line-height: 1.6;
      margin-bottom: 40px;
      letter-spacing: 0.5px;
    }

    .start-button {
      background: transparent;
      color: #e8e8e8;
      border: 2px solid rgba(255,255,255,0.2);
      padding: 16px 32px;
      font-size: 16px;
      font-family: 'Georgia', serif;
      cursor: pointer;
      border-radius: 0;
      transition: all 0.4s ease;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .start-button:hover,
    .start-button:focus {
      border-color: rgba(255,255,255,0.6);
      background: rgba(255,255,255,0.05);
      transform: translateY(-2px);
    }

    .start-container.hidden {
      opacity: 0;
      pointer-events: none;
      transition: opacity 1s ease;
    }

    .text-fragment {
      position: absolute;
      font-size: 20px;
      max-width: 480px;
      line-height: 1.5;
      color: #f0f0f0;
      pointer-events: none;
      z-index: 10;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.8s cubic-bezier(0.4, 0.0, 0.2, 1);
      letter-spacing: 0.3px;
    }

    .text-fragment.appear {
      opacity: 1;
      transform: translateY(0);
    }

    .text-fragment.fade-out {
      opacity: 0;
      transform: translateY(-10px);
      transition: all 1.5s ease-out;
    }

    .text-fragment.precious {
      color: #ffd700;
      text-shadow: 0 0 1px rgba(255,215,0,0.5);
    }

    .text-fragment.confused {
      color: #ff9999;
      font-style: italic;
    }

    .text-fragment.paranoid {
      color: #ff6b6b;
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    .final-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 36px;
      font-weight: normal;
      color: #fff;
      text-align: center;
      background: rgba(0, 0, 0, 0.9);
      padding: 40px 50px;
      border-radius: 0;
      opacity: 0;
      transition: opacity 4s ease-in;
      z-index: 2000;
      cursor: pointer;
      letter-spacing: 2px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .final-message.visible {
      opacity: 1;
    }

    .final-message.replay-ready {
      border-color: rgba(255,255,255,0.3);
      cursor: pointer;
      animation: gentle-pulse 3s infinite ease-in-out;
    }

    @keyframes gentle-pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }

    .replay-fragment {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 24px;
      color: #ffd700;
      text-align: center;
      z-index: 2100;
      opacity: 0;
      transition: opacity 3s ease-in;
      pointer-events: none;
      text-shadow: 0 0 2px rgba(255,215,0,0.3);
      max-width: 600px;
      line-height: 1.4;
    }

    .replay-fragment.visible {
      opacity: 1;
    }

    .progress-indicator {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      width: 300px;
      height: 2px;
      background: rgba(255,255,255,0.1);
      border-radius: 1px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ffd700, #ff6b6b);
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 1px;
    }

    /* Accessibility */
    :focus-visible {
      outline: 2px solid rgba(255,255,255,0.6);
      outline-offset: 4px;
    }

    @media (max-width: 768px) {
      .text-fragment {
        font-size: 18px;
        max-width: 90%;
      }
      
      .final-message {
        font-size: 28px;
        padding: 30px 40px;
      }
    }
  </style>
</head>
<body tabindex="0">
  <div class="cursor" id="cursor"></div>

  <div class="hud memory-counter" id="memory-counter" role="status" aria-live="polite" aria-atomic="true">
    <span id="memory-count">900</span> MB remaining
  </div>

  <div class="progress-indicator">
    <div class="progress-bar" id="progress-bar"></div>
  </div>

  <div class="start-container" id="start-container">
    <div class="start-text">
      Each movement through this space<br />
      costs what cannot be returned.<br /><br />
      Move as you feel called to move.
    </div>
    <button class="start-button" id="start-button">Begin</button>
  </div>

  <div id="aria-live-fragment" aria-live="polite" aria-atomic="true" style="position:absolute; left:-9999px; height:1px; width:1px; overflow:hidden;"></div>

  <div class="final-message" id="final-message" role="alert" aria-live="assertive" aria-atomic="true">
    Connection<br />Lost
  </div>

  <div class="replay-fragment" id="replay-fragment"></div>

  <script>
    const POEM_LINES = [
      { text: "Her voice calls from another room.", cost: 8, type: "precious" },
      { text: "Tea holds warmth in my hands.", cost: 10, type: "precious" },
      { text: "She says 'Dad' and I am still here.", cost: 12, type: "precious" },
      { text: "My footsteps sometimes lose me.", cost: 16, type: "precious" },
      { text: "Thoughts graze paddocksâ€“slow cattle.", cost: 18, type: "precious" },
      { text: "Her small hand: my first understanding of love.", cost: 20, type: "precious" },
      { text: "I used to be a first call.", cost: 22, type: "precious" },
      { text: "Our morning ritual was the whole world.", cost: 24, type: "precious" },
      { text: "A woman was here, tea still steams.", cost: 26, type: "confused" },
      { text: "I told her stories of summer light.", cost: 28, type: "confused" },
      { text: "Her name: three syllables I can't hold.", cost: 30, type: "confused" },
      { text: "Now reaches uncertain, guiding me to a chair.", cost: 32, type: "confused" },
      { text: "Something paces behind walls.", cost: 34, type: "confused" },
      { text: "Furniture moves when I'm not looking.", cost: 36, type: "paranoid" },
      { text: "A voice I should know calls my name.", cost: 38, type: "paranoid" },
      { text: "This room forgets it knows me.", cost: 40, type: "paranoid" },
      { text: "'Dad' arrives but too late.", cost: 42, type: "paranoid" },
      { text: "Touch hesitates at the door.", cost: 44, type: "paranoid" },
      { text: "The walls remember someone else.", cost: 46, type: "paranoid" },
      { text: "They speak my name like a question.", cost: 48, type: "paranoid" },
      { text: "This woman brings pills and lies.", cost: 50, type: "paranoid" },
      { text: "The house has been planning this: my thoughts being stolen.", cost: 52, type: "paranoid" },
      { text: "The mirror blinks first now.", cost: 54, type: "paranoid" },
      { text: "They come for what's left.", cost: 56, type: "paranoid" },
      { text: "She claims to be my daughter.", cost: 58, type: "paranoid" },
      { text: "The bed is empty; the heart beats somewhere else.", cost: 60, type: "paranoid" },
      { text: "I am still here but not me.", cost: 62, type: "paranoid" },
      { text: "Connection lost.", cost: 64, type: "paranoid" }
    ];

    const START_MEMORY = 900;
    const MEMORY_WARNING_THRESHOLD = 150;

    const elements = {
      cursor: document.getElementById('cursor'),
      memoryCounter: document.getElementById('memory-counter'),
      memoryCount: document.getElementById('memory-count'),
      startContainer: document.getElementById('start-container'),
      startButton: document.getElementById('start-button'),
      progressBar: document.getElementById('progress-bar'),
      finalMessage: document.getElementById('final-message'),
      replayFragment: document.getElementById('replay-fragment'),
      ariaLiveFragment: document.getElementById('aria-live-fragment'),
    };

    let memory = START_MEMORY;
    let index = 0;
    let lastX = window.innerWidth / 2;
    let lastY = window.innerHeight / 2;
    let running = false;
    let fadeOutFragments = [];

    function setupCursor() {
      window.addEventListener('mousemove', e => {
        elements.cursor.style.left = `${e.clientX}px`;
        elements.cursor.style.top = `${e.clientY}px`;
        lastX = e.clientX;
        lastY = e.clientY;
        document.body.style.setProperty('--mouse-x', `${(e.clientX / window.innerWidth) * 100}%`);
        document.body.style.setProperty('--mouse-y', `${(e.clientY / window.innerHeight) * 100}%`);
      });
    }

    function createTextFragment(text, x, y, type) {
      const fragment = document.createElement('div');
      fragment.classList.add('text-fragment');
      if (type) fragment.classList.add(type);
      fragment.textContent = text;
      fragment.style.left = `${x}px`;
      fragment.style.top = `${y}px`;
      document.body.appendChild(fragment);

      // Animate appear
      requestAnimationFrame(() => {
        fragment.classList.add('appear');
      });

      // Schedule fade out after 5 seconds
      setTimeout(() => {
        fragment.classList.add('fade-out');
        setTimeout(() => {
          fragment.remove();
        }, 1500);
      }, 5000);

      return fragment;
    }

    function flashMemoryCounter() {
      elements.memoryCounter.classList.add('flash');
      setTimeout(() => {
        elements.memoryCounter.classList.remove('flash');
      }, 600);
    }

    function updateMemoryCost(cost) {
      memory -= cost;
      if (memory < 0) memory = 0;
      elements.memoryCount.textContent = memory;

      if (memory <= MEMORY_WARNING_THRESHOLD) {
        elements.memoryCounter.style.color = '#ff6b6b';
        elements.memoryCounter.style.borderColor = 'rgba(255,107,107,0.8)';
        elements.memoryCounter.style.boxShadow = '0 0 10px rgba(255,107,107,0.6)';
      } else {
        elements.memoryCounter.style.color = '#ff6b6b';
        elements.memoryCounter.style.borderColor = 'rgba(255,107,107,0.3)';
        elements.memoryCounter.style.boxShadow = 'none';
      }
    }

    function updateProgress() {
      let percent = ((POEM_LINES.length - index) / POEM_LINES.length) * 100;
      elements.progressBar.style.width = `${percent}%`;
    }

    function startGame() {
      if (running) return;
      running = true;

      elements.startContainer.classList.add('hidden');
      setTimeout(() => {
        elements.startContainer.style.display = 'none';
      }, 1000);

      document.body.classList.add('active');
      updateProgress();
      showNextLine();
    }

    function showNextLine() {
      if (index >= POEM_LINES.length) {
        endGame();
        return;
      }

      const line = POEM_LINES[index];
      index++;

      // Pick a random position near last cursor position but not off screen
      const margin = 100;
      let x = lastX + (Math.random() * 200 - 100);
      let y = lastY + (Math.random() * 100 - 50);
      x = Math.min(window.innerWidth - margin, Math.max(margin, x));
      y = Math.min(window.innerHeight - margin, Math.max(margin, y));

      createTextFragment(line.text, x, y, line.type);

      updateMemoryCost(line.cost);
      flashMemoryCounter();
      updateProgress();

      elements.ariaLiveFragment.textContent = line.text; // For screen readers

      if (memory <= 0) {
        endGame();
        return;
      }

      // Schedule next line randomly between 4-8 seconds
      const delay = 4000 + Math.random() * 4000;
      setTimeout(showNextLine, delay);
    }

    function endGame() {
      running = false;
      elements.finalMessage.classList.add('visible');

      // After delay, show replay message
      setTimeout(() => {
        elements.replayFragment.textContent = 'Click here or press any key to restart.';
        elements.replayFragment.classList.add('visible');
        elements.finalMessage.classList.add('replay-ready');

        function restartHandler() {
          elements.replayFragment.classList.remove('visible');
          elements.finalMessage.classList.remove('visible', 'replay-ready');
          memory = START_MEMORY;
          index = 0;
          elements.memoryCount.textContent = memory;
          elements.memoryCounter.style.color = '#ff6b6b';
          elements.memoryCounter.style.borderColor = 'rgba(255,107,107,0.3)';
          elements.memoryCounter.style.boxShadow = 'none';
          elements.progressBar.style.width = '100%';
          elements.startContainer.style.display = 'block';
          elements.startContainer.classList.remove('hidden');
          document.body.classList.remove('active');

          document.removeEventListener('keydown', restartHandler);
          elements.finalMessage.removeEventListener('click', restartHandler);
          setupStartButton();
        }

        document.addEventListener('keydown', restartHandler);
        elements.finalMessage.addEventListener('click', restartHandler);
      }, 2000);
    }

    function setupStartButton() {
      // Remove old event listeners just in case
      elements.startButton.replaceWith(elements.startButton.cloneNode(true));
      elements.startButton = document.getElementById('start-button');

      // Instead of listening to startButton click only,
      // listen to any first click on document to start the game.
      function firstClickStartHandler(e) {
        startGame();
        document.removeEventListener('click', firstClickStartHandler);
      }

      document.addEventListener('click', firstClickStartHandler, { once: true });

      elements.startButton.focus();
    }

    // Initialize on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      setupCursor();
      setupStartButton();
    });
  </script>
</body>
</html>
